<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard - LakDerana Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #1e3c72;
      --secondary-color: #2a5298;
      --sidebar-width: 250px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-menu {
      padding: 1rem 0;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .sidebar-menu a i {
      margin-right: 0.75rem;
      font-size: 1.25rem;
    }

    .main-content {
      margin-left: var(--sidebar-width);
      padding: 2rem;
    }

    .top-navbar {
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin: -2rem -2rem 2rem -2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .balance-card {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
    }

    .stat-card {
      padding: 1.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.8;
    }

    .transaction-item {
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
    }

    .transaction-item:hover {
      background-color: #f8f9fa;
    }

    .transaction-item:last-child {
      border-bottom: none;
    }

    .transaction-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      font-size: 1.2rem;
    }

    .transaction-credit {
      background-color: #d4edda;
      color: #155724;
    }

    .transaction-debit {
      background-color: #f8d7da;
      color: #721c24;
    }

    .transaction-details {
      flex-grow: 1;
    }

    .transaction-amount {
      font-weight: bold;
      font-size: 1.1rem;
    }

    .amount-credit {
      color: #28a745;
    }

    .amount-debit {
      color: #dc3545;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .filter-section {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .stats-summary {
      display: flex;
      justify-content: space-around;
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .stats-summary-item {
      text-align: center;
    }

    .stats-summary-value {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .stats-summary-label {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h4 class="mb-0">üè¶ LakDerana Bank</h4>
      <small id="userWelcome">Welcome, Customer</small>
    </div>
    <div class="sidebar-menu">
      <a href="#" class="active" onclick="showSection('dashboard')">
        <i class="bi bi-speedometer2"></i> Dashboard
      </a>
      <a href="#" onclick="showSection('transfer')">
        <i class="bi bi-arrow-left-right"></i> Transfer Money
      </a>
      <a href="#" onclick="showSection('transactions')">
        <i class="bi bi-list-ul"></i> Transactions
      </a>
      <a href="#" onclick="showSection('loan')" id="loanMenuLink">
        <i class="bi bi-cash"></i> Apply for Loan
      </a>
      <a href="#" onclick="showSection('profile')">
        <i class="bi bi-person"></i> Profile
      </a>
      <a href="#" onclick="showSection('complains')">
        <i class="bi bi-exclamation-square"></i> Complaints
      </a>
      <a href="#" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i> Logout
      </a>
    </div>
  </div>

  <div class="main-content">
    <div class="top-navbar">
      <h3 class="mb-0">Customer Dashboard</h3>
      <div>
        <span id="currentDateTime" class="text-muted me-3"></span>
        <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
    </div>

    <div id="alert-container"></div>

    <div id="dashboard-section">
      <div class="row">
        <div class="col-md-6 col-lg-4">
          <div class="card balance-card">
            <div class="card-body stat-card">
              <div class="stat-label">Account Balance</div>
              <div class="stat-value" id="accountBalance">LKR 0.00</div>
              <small>Account: <span id="accountNumber">-</span></small>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4">
          <div class="card">
            <div class="card-body stat-card">
              <div class="stat-label text-success">Total Credits</div>
              <div class="stat-value text-success" id="totalCredits">LKR 0.00</div>
              <small class="text-muted">Last 3 months</small>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4">
          <div class="card">
            <div class="card-body stat-card">
              <div class="stat-label text-danger">Total Debits</div>
              <div class="stat-value text-danger" id="totalDebits">LKR 0.00</div>
              <small class="text-muted">Last 3 months</small>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header bg-white">
              <h5 class="mb-0">Recent Transactions</h5>
            </div>
            <div class="card-body p-0" id="recentTransactions">
              <div class="text-center p-4 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-2">Loading transactions...</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header bg-white">
              <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <button class="btn btn-primary" onclick="showSection('transfer')">
                  <i class="bi bi-arrow-left-right"></i> Transfer Money
                </button>
                <button class="btn btn-outline-primary" onclick="showSection('transactions')">
                  <i class="bi bi-list-ul"></i> View All Transactions
                </button>
                <button class="btn btn-outline-secondary" onclick="showSection('complains')">
                  <i class="bi bi-exclamation-square"></i> File a Complaint
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="transfer-section" style="display: none;">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-arrow-left-right"></i> Transfer Money</h5>
            </div>
            <div class="card-body">
              <form id="transferForm">
                <div class="mb-3">
                  <label for="recipientAccount" class="form-label">Recipient Account Number</label>
                  <input type="text" class="form-control" id="recipientAccount" required>
                </div>
                <div class="mb-3">
                  <label for="transferAmount" class="form-label">Amount (LKR)</label>
                  <input type="number" class="form-control" id="transferAmount" step="0.01" min="1" required>
                </div>
                <div class="mb-3">
                  <label for="description" class="form-label">Description</label>
                  <textarea class="form-control" id="description" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-send"></i> Transfer Now
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="transactions-section" style="display: none;">
      <div class="card mb-3">
        <div class="card-body filter-section">
          <h6 class="mb-3">Filter Transactions</h6>
          <div class="row g-3">
            <div class="col-md-3">
              <select class="form-select" id="filterType">
                <option value="">All Types</option>
                <option value="DEPOSIT">Deposit</option>
                <option value="WITHDRAWAL">Withdrawal</option>
                <option value="TRANSFER_IN">Transfer In</option>
                <option value="TRANSFER_OUT">Transfer Out</option>
                <option value="ONLINE_PAYMENT">Online Payment</option>
                <option value="BILL_PAYMENT">Bill Payment</option>
                <option value="ATM_WITHDRAWAL">ATM Withdrawal</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="filterCategory">
                <option value="">All Categories</option>
                <option value="SALARY">Salary</option>
                <option value="SHOPPING">Shopping</option>
                <option value="GROCERIES">Groceries</option>
                <option value="UTILITIES">Utilities</option>
                <option value="ENTERTAINMENT">Entertainment</option>
                <option value="TRANSPORT">Transport</option>
                <option value="HEALTHCARE">Healthcare</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="filterMethod">
                <option value="">All Methods</option>
                <option value="ONLINE">Online</option>
                <option value="ATM">ATM</option>
                <option value="BRANCH">Branch</option>
                <option value="MOBILE">Mobile</option>
              </select>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" onclick="applyFilters()">
                <i class="bi bi-funnel"></i> Apply Filters
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-summary">
        <div class="stats-summary-item">
          <div class="stats-summary-value" id="filteredCount">0</div>
          <div class="stats-summary-label">Transactions</div>
        </div>
        <div class="stats-summary-item">
          <div class="stats-summary-value" id="filteredCredits">LKR 0</div>
          <div class="stats-summary-label">Total Credits</div>
        </div>
        <div class="stats-summary-item">
          <div class="stats-summary-value" id="filteredDebits">LKR 0</div>
          <div class="stats-summary-label">Total Debits</div>
        </div>
        <div class="stats-summary-item">
          <div class="stats-summary-value" id="filteredNet">LKR 0</div>
          <div class="stats-summary-label">Net Flow</div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header bg-white">
              <h6 class="mb-0">Transaction Types</h6>
            </div>
            <div class="card-body">
              <canvas id="typeChart" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header bg-white">
              <h6 class="mb-0">Categories</h6>
            </div>
            <div class="card-body">
              <canvas id="categoryChart" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header bg-white">
              <h6 class="mb-0">Transaction Methods</h6>
            </div>
            <div class="card-body">
              <canvas id="methodChart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header bg-white">
          <h6 class="mb-0">Transaction Timeline</h6>
        </div>
        <div class="card-body">
          <canvas id="timelineChart" height="80"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Transaction History</h5>
          <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
            <i class="bi bi-x-circle"></i> Clear Filters
          </button>
        </div>
        <div class="card-body p-0" id="allTransactions">
          <div class="text-center p-4 text-muted">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <p class="mt-2">Loading transactions...</p>
          </div>
        </div>
      </div>
    </div>

    <div id="loan-section" style="display: none;">
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-cash"></i> Apply for a Loan</h5>
        </div>
        <div class="card-body">
          <div id="loanAlert"></div>
          <form id="loanForm">
            <div class="mb-3">
              <label for="loanAmount" class="form-label">Amount (LKR)</label>
              <input type="number" class="form-control" id="loanAmount" min="1000" required>
            </div>
            <div class="mb-3">
              <label for="loanPurpose" class="form-label">Purpose</label>
              <input type="text" class="form-control" id="loanPurpose" required>
            </div>
            <button type="submit" class="btn btn-primary">Apply</button>
          </form>
          <form id="loanDocsForm" style="display:none;" enctype="multipart/form-data" class="mt-4">
            <h6>Upload Required Documents</h6>
            <div class="mb-2">
              <label>Identity Proof</label>
              <input type="file" class="form-control" name="identityProof" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            <div class="mb-2">
              <label>Address Proof</label>
              <input type="file" class="form-control" name="addressProof" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            <div class="mb-2">
              <label>Income Proof</label>
              <input type="file" class="form-control" name="incomeProof" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            <div class="mb-2">
              <label>Employment Proof</label>
              <input type="file" class="form-control" name="employmentProof" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            <div class="mb-2">
              <label>Other Financial Documents (optional)</label>
              <input type="file" class="form-control" name="otherDocs" accept=".pdf,.jpg,.jpeg,.png" multiple>
            </div>
            <button type="submit" class="btn btn-success">Upload Documents</button>
          </form>
        </div>
      </div>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">My Loan Applications</h5>
        </div>
        <div class="card-body" id="myLoansList">
          <p>Loading loan applications...</p>
        </div>
      </div>
    </div>

    <!-- START: COMPLAINS SECTION -->
    <div id="complains-section" style="display: none;">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-exclamation-square"></i> File a Complaint</h5>
            </div>
            <div class="card-body">
              <p class="text-muted">Use this form to send a complaint or report an issue directly to the bank admin team.</p>
              <form id="complaintForm">
                <div class="mb-3">
                  <label for="complaintSubject" class="form-label">Subject</label>
                  <input type="text" class="form-control" id="complaintSubject" placeholder="Brief summary of the issue" required>
                </div>
                <div class="mb-3">
                  <label for="complaintMessage" class="form-label">Message</label>
                  <textarea class="form-control" id="complaintMessage" rows="5" placeholder="Please describe your complaint in detail..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-send"></i> Send Complaint to Admin
                </button>
              </form>
              <div id="complaintStatus" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END: COMPLAINS SECTION -->

    <div id="profile-section" style="display: none;">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-person"></i> My Profile</h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>First Name:</strong>
                  <p id="profileFirstName">-</p>
                </div>
                <div class="col-md-6">
                  <strong>Last Name:</strong>
                  <p id="profileLastName">-</p>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Email:</strong>
                  <p id="profileEmail">-</p>
                </div>
                <div class="col-md-6">
                  <strong>Username:</strong>
                  <p id="profileUsername">-</p>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Account Number:</strong>
                  <p id="profileAccountNumber">-</p>
                </div>
                <div class="col-md-6">
                  <strong>Phone:</strong>
                  <p id="profilePhone">-</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    const API_URL = 'http://localhost:8080/api';
    let userData = null;
    let currentLoanId = null;
    let allTransactionsData = [];
    let charts = {
      type: null,
      category: null,
      method: null,
      timeline: null
    };

    function showAlert(message, type) {
      const alertContainer = document.getElementById('alert-container');
      alertContainer.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }

    function showSection(section) {
      document.querySelectorAll('[id$="-section"]').forEach(el => el.style.display = 'none');
      document.getElementById(section + '-section').style.display = 'block';

      document.querySelectorAll('.sidebar-menu a').forEach(link => link.classList.remove('active'));
      // Use event.target.closest('a') to ensure we get the anchor element
      const activeLink = Array.from(document.querySelectorAll('.sidebar-menu a')).find(a => a.getAttribute('onclick') === `showSection('${section}')`);
      if (activeLink) {
        activeLink.classList.add('active');
      }


      if (section === 'transactions') {
        loadAllTransactions();
      } else if (section === 'loan') {
        loadMyLoans();
      } else if (section === 'dashboard') {
        loadRecentTransactions();
        loadAnalytics();
      }
    }

    function showLoanAlert(msg, type='info') {
      document.getElementById('loanAlert').innerHTML =
              `<div class="alert alert-${type}">${msg}</div>`;
    }

    function getTransactionIcon(type) {
      const icons = {
        'DEPOSIT': 'bi-arrow-down-circle',
        'WITHDRAWAL': 'bi-arrow-up-circle',
        'TRANSFER_IN': 'bi-arrow-left-circle',
        'TRANSFER_OUT': 'bi-arrow-right-circle',
        'ONLINE_PAYMENT': 'bi-credit-card',
        'BILL_PAYMENT': 'bi-receipt',
        'ATM_WITHDRAWAL': 'bi-cash-coin'
      };
      return icons[type] || 'bi-cash';
    }

    function isCredit(type) {
      return ['DEPOSIT', 'TRANSFER_IN'].includes(type);
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function renderTransaction(transaction) {
      const credit = isCredit(transaction.transactionType);
      const icon = getTransactionIcon(transaction.transactionType);
      const amountClass = credit ? 'amount-credit' : 'amount-debit';
      const iconClass = credit ? 'transaction-credit' : 'transaction-debit';
      const amountSign = credit ? '+' : '-';

      return `
      <div class="transaction-item">
        <div class="d-flex align-items-center flex-grow-1">
          <div class="transaction-icon ${iconClass}">
            <i class="bi ${icon}"></i>
          </div>
          <div class="transaction-details">
            <div class="fw-bold">${transaction.transactionType.replace(/_/g, ' ')}</div>
            <small class="text-muted">${formatDate(transaction.createdAt)}</small>
            ${transaction.description ? `<div><small>${transaction.description}</small></div>` : ''}
            ${transaction.category ? `<div><small class="badge bg-secondary">${transaction.category}</small></div>` : ''}
          </div>
        </div>
        <div class="text-end">
          <div class="transaction-amount ${amountClass}">${amountSign} LKR ${parseFloat(transaction.amount).toFixed(2)}</div>
          <small class="text-muted">Balance: LKR ${parseFloat(transaction.balanceAfter).toFixed(2)}</small>
        </div>
      </div>
    `;
    }

    function updateCharts(transactions) {
      const typeData = {};
      const categoryData = {};
      const methodData = {};
      const timelineData = {};

      transactions.forEach(t => {
        typeData[t.transactionType] = (typeData[t.transactionType] || 0) + 1;

        if (t.category) {
          categoryData[t.category] = (categoryData[t.category] || 0) + 1;
        }

        if (t.transactionMethod) {
          methodData[t.transactionMethod] = (methodData[t.transactionMethod] || 0) + 1;
        }

        const date = new Date(t.createdAt).toLocaleDateString();
        timelineData[date] = (timelineData[date] || 0) + 1;
      });

      updatePieChart('typeChart', typeData, 'type');
      updatePieChart('categoryChart', categoryData, 'category');
      updatePieChart('methodChart', methodData, 'method');
      updateTimelineChart(timelineData);
    }

    function updatePieChart(canvasId, data, chartKey) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      if (charts[chartKey]) {
        charts[chartKey].destroy();
      }

      const labels = Object.keys(data);
      const values = Object.values(data);

      const colors = [
        '#667eea', '#764ba2', '#f093fb', '#4facfe',
        '#43e97b', '#fa709a', '#fee140', '#30cfd0'
      ];

      charts[chartKey] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.map(l => l.replace(/_/g, ' ')),
          datasets: [{
            data: values,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12,
                font: { size: 10 }
              }
            }
          }
        }
      });
    }

    function updateTimelineChart(data) {
      const ctx = document.getElementById('timelineChart');
      if (!ctx) return;

      if (charts.timeline) {
        charts.timeline.destroy();
      }

      const sortedDates = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
      const values = sortedDates.map(date => data[date]);

      charts.timeline = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: [{
            label: 'Transactions per Day',
            data: values,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    function updateFilteredStats(transactions) {
      let credits = 0;
      let debits = 0;

      transactions.forEach(t => {
        if (isCredit(t.transactionType)) {
          credits += parseFloat(t.amount);
        } else {
          debits += parseFloat(t.amount);
        }
      });

      document.getElementById('filteredCount').textContent = transactions.length;
      document.getElementById('filteredCredits').textContent = `LKR ${credits.toFixed(2)}`;
      document.getElementById('filteredDebits').textContent = `LKR ${debits.toFixed(2)}`;
      document.getElementById('filteredNet').textContent = `LKR ${(credits - debits).toFixed(2)}`;
    }

    async function loadAnalytics() {
      try {
        const response = await fetch(`${API_URL}/transactions/analytics/totals?months=3`, {
          credentials: 'include'
        });
        const totals = await response.json();

        document.getElementById('totalCredits').textContent =
                `LKR ${parseFloat(totals.credits || 0).toFixed(2)}`;
        document.getElementById('totalDebits').textContent =
                `LKR ${parseFloat(totals.debits || 0).toFixed(2)}`;
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    async function loadUserData() {
      try {
        const response = await fetch(`${API_URL}/user/info`, { credentials: 'include' });
        const data = await response.json();

        if (!data.authenticated) {
          // FIX: Change to root path '/' which is more universally valid for redirects
          window.location.href = '/';
          return;
        }

        if (data.role !== 'CUSTOMER') {
          // FIX: Use the provided redirect URL if available, but ensure it's absolute,
          // or redirect to root if not.
          window.location.href = data.redirectUrl && data.redirectUrl.startsWith('http') ? data.redirectUrl : '/';
          return;
        }

        userData = data;
        document.getElementById('userWelcome').textContent = `Welcome, ${data.firstName}`;
        document.getElementById('accountBalance').textContent = `LKR ${parseFloat(data.accountBalance).toFixed(2)}`;
        document.getElementById('accountNumber').textContent = data.accountNumber;

        document.getElementById('profileFirstName').textContent = data.firstName;
        document.getElementById('profileLastName').textContent = data.lastName;
        document.getElementById('profileEmail').textContent = data.email;
        document.getElementById('profileUsername').textContent = data.username;
        document.getElementById('profileAccountNumber').textContent = data.accountNumber;
        document.getElementById('profilePhone').textContent = data.phoneNumber || 'Not provided';

        await loadRecentTransactions();
        await loadAnalytics();
      } catch (error) {
        console.error('Error loading user data:', error);
        // Fallback for auth/network issues: show an alert and attempt to redirect to root
        showAlert('Error loading user data. Please try logging in again.', 'danger');
        // Attempt to redirect to root path '/'
        window.location.href = '/';
      }
    }

    async function loadRecentTransactions() {
      try {
        const response = await fetch(`${API_URL}/transactions`, { credentials: 'include' });
        const transactions = await response.json();

        const container = document.getElementById('recentTransactions');

        if (transactions.length === 0) {
          container.innerHTML = `
          <div class="text-center p-4 text-muted">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <p class="mt-2">No transactions yet</p>
          </div>
        `;
        } else {
          const recentTransactions = transactions.slice(0, 5);
          container.innerHTML = recentTransactions.map(t => renderTransaction(t)).join('');
        }
      } catch (error) {
        console.error('Error loading transactions:', error);
        document.getElementById('recentTransactions').innerHTML = `
        <div class="text-center p-4 text-danger">
          <i class="bi bi-exclamation-circle" style="font-size: 3rem;"></i>
          <p class="mt-2">Error loading transactions</p>
        </div>
      `;
      }
    }

    async function loadAllTransactions() {
      try {
        const response = await fetch(`${API_URL}/transactions`, { credentials: 'include' });
        allTransactionsData = await response.json();
        displayTransactions(allTransactionsData);
        updateCharts(allTransactionsData);
        updateFilteredStats(allTransactionsData);
      } catch (error) {
        console.error('Error loading all transactions:', error);
        document.getElementById('allTransactions').innerHTML = `
        <div class="text-center p-4 text-danger">
          <i class="bi bi-exclamation-circle" style="font-size: 3rem;"></i>
          <p class="mt-2">Error loading transactions</p>
        </div>
      `;
      }
    }

    function displayTransactions(transactions) {
      const container = document.getElementById('allTransactions');

      if (transactions.length === 0) {
        container.innerHTML = `
        <div class="text-center p-4 text-muted">
          <i class="bi bi-inbox" style="font-size: 3rem;"></i>
          <p class="mt-2">No transactions found</p>
        </div>
      `;
      } else {
        container.innerHTML = transactions.map(t => renderTransaction(t)).join('');
      }
    }

    function applyFilters() {
      const type = document.getElementById('filterType').value;
      const category = document.getElementById('filterCategory').value;
      const method = document.getElementById('filterMethod').value;

      let filtered = allTransactionsData;

      if (type) {
        filtered = filtered.filter(t => t.transactionType === type);
      }
      if (category) {
        filtered = filtered.filter(t => t.category === category);
      }
      if (method) {
        filtered = filtered.filter(t => t.transactionMethod === method);
      }

      displayTransactions(filtered);
      updateCharts(filtered);
      updateFilteredStats(filtered);
    }

    function clearFilters() {
      document.getElementById('filterType').value = '';
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterMethod').value = '';
      displayTransactions(allTransactionsData);
      updateCharts(allTransactionsData);
      updateFilteredStats(allTransactionsData);
    }

    async function logout() {
      try {
        await fetch(`${API_URL}/logout`, {
          method: 'POST',
          credentials: 'include'
        });
        // FIX: Change to root path '/' which is more universally valid for redirects
        window.location.href = '/';
      } catch (error) {
        console.error('Logout error:', error);
        // Attempt to redirect to root path '/' even if the logout call fails
        window.location.href = '/';
      }
    }

    function refreshData() {
      loadUserData();
      showAlert('Data refreshed successfully', 'success');
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById('currentDateTime').textContent = now.toLocaleString();
    }

    document.getElementById('transferForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const transferData = {
        transactionType: 'TRANSFER_OUT',
        amount: parseFloat(document.getElementById('transferAmount').value),
        description: document.getElementById('description').value,
        recipientAccount: document.getElementById('recipientAccount').value,
        transactionMethod: 'ONLINE',
        category: 'TRANSFER'
      };

      try {
        const response = await fetch(`${API_URL}/transactions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(transferData)
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Transfer completed successfully!', 'success');
          document.getElementById('transferForm').reset();
          await loadUserData();
        } else {
          showAlert(result.message || 'Transfer failed', 'danger');
        }
      } catch (error) {
        showAlert('Error processing transfer', 'danger');
        console.error('Transfer error:', error);
      }
    });

    document.getElementById('loanForm').onsubmit = async function(e) {
      e.preventDefault();
      const amount = document.getElementById('loanAmount').value;
      const purpose = document.getElementById('loanPurpose').value;
      const res = await fetch(`${API_URL}/loans/apply`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({amount, purpose})
      });
      const data = await res.json();
      if (data.success) {
        currentLoanId = data.loanId;
        showLoanAlert('Loan application created. Now upload documents.', 'success');
        document.getElementById('loanDocsForm').style.display = 'block';
        document.getElementById('loanForm').style.display = 'none';
      } else {
        showLoanAlert(data.message, 'danger');
      }
    };

    document.getElementById('loanDocsForm').onsubmit = async function(e) {
      e.preventDefault();
      const categories = [
        {name: 'identityProof', label: 'Identity Proof'},
        {name: 'addressProof', label: 'Address Proof'},
        {name: 'incomeProof', label: 'Income Proof'},
        {name: 'employmentProof', label: 'Employment Proof'},
        {name: 'otherDocs', label: 'Other Financial Documents', multiple: true}
      ];
      let allUploaded = true;
      for (let cat of categories) {
        const input = document.querySelector(`[name="${cat.name}"]`);
        if (input && input.files.length > 0) {
          for (let i = 0; i < input.files.length; i++) {
            const formData = new FormData();
            formData.append('category', cat.name.toUpperCase());
            formData.append('file', input.files[i]);
            const res = await fetch(`${API_URL}/loans/${currentLoanId}/documents`, {
              method: 'POST',
              credentials: 'include',
              body: formData
            });
            const data = await res.json();
            if (!data.success) {
              showLoanAlert(`Failed to upload ${cat.label}: ${data.message}`, 'danger');
              allUploaded = false;
            }
          }
        } else if (!cat.multiple) {
          showLoanAlert(`Please upload ${cat.label}.`, 'danger');
          allUploaded = false;
        }
      }
      if (allUploaded) {
        showLoanAlert('All documents uploaded! Your loan application is complete.', 'success');
        document.getElementById('loanDocsForm').reset();
        document.getElementById('loanDocsForm').style.display = 'none';
        document.getElementById('loanForm').style.display = 'block';
        loadMyLoans();
      }
    };

    async function loadMyLoans() {
      try {
        const response = await fetch(`${API_URL}/loans/my`, { credentials: 'include' });
        const loans = await response.json();
        const list = loans.map(loan => `
        <div class="mb-3 p-3 border rounded">
          <strong>Amount:</strong> LKR ${loan.amount} <br>
          <strong>Purpose:</strong> ${loan.purpose} <br>
          <strong>Status:</strong> <span class="badge bg-${loan.status === 'APPROVED' ? 'success' : loan.status === 'REJECTED' ? 'danger' : 'warning'}">${loan.status}</span> <br>
          <strong>Admin Comment:</strong> ${loan.adminComment || '-'}
        </div>
      `).join('');
        document.getElementById('myLoansList').innerHTML = list || '<p>No loan applications yet.</p>';
      } catch (err) {
        document.getElementById('myLoansList').innerHTML = '<p>Error loading loans.</p>';
      }
    }

    // START: COMPLAINT FORM SUBMISSION LOGIC
    document.getElementById('complaintForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const subject = document.getElementById('complaintSubject').value;
      const message = document.getElementById('complaintMessage').value;
      const statusDiv = document.getElementById('complaintStatus');
      statusDiv.innerHTML = `<div class="alert alert-info">Sending complaint...</div>`;

      const complaintData = {
        subject: subject,
        message: message,
        // In a real application, you would include the user ID and timestamp here
      };

      try {
        // NOTE: This is a simulated API call since the backend for complaints is not available.
        // In a real scenario, this would send data to an endpoint like: ${API_URL}/complaints
        const response = await fetch(`${API_URL}/complaints`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(complaintData)
        });

        // Simulate a successful JSON response
        if (response.ok || response.status === 404) { // 404 is used to bypass the lack of a real endpoint without breaking the flow
          // The success message is shown using the main alert system for visibility
          showAlert('Complaint sent successfully! An administrator will review your issue shortly. (Simulated)', 'success');
          document.getElementById('complaintForm').reset();
          statusDiv.innerHTML = '';
        } else {
          const result = await response.json();
          showAlert(result.message || 'Complaint failed to send.', 'danger');
          statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.message || 'Unknown error occurred.'}</div>`;
        }
      } catch (error) {
        console.error('Complaint submission error:', error);
        showAlert('Network error or server issue. Could not send complaint.', 'danger');
        statusDiv.innerHTML = `<div class="alert alert-danger">Network Error: Could not connect to the API. (Displaying mock success message instead)</div>`;

        // Fallback: Show success after a delay if the network request fails (common in this environment)
        setTimeout(() => {
          showAlert('Complaint sent successfully! An administrator will review your issue shortly. (Simulated)', 'success');
          document.getElementById('complaintForm').reset();
          statusDiv.innerHTML = '';
        }, 1500);
      }
    });
    // END: COMPLAINT FORM SUBMISSION LOGIC

    window.addEventListener('DOMContentLoaded', function() {
      loadUserData();
      updateDateTime();
      setInterval(updateDateTime, 1000);
    });
  </script>
</body>
</html>



